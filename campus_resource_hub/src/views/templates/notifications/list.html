{% extends "base.html" %}

{% block title %}Notifications - Campus Resource Hub{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Notifications</h1>
        <div>
            <a href="{{ url_for('notification.list', filter='all') }}" class="btn btn-outline-secondary btn-sm {% if filter_type == 'all' %}active{% endif %}">All</a>
            <a href="{{ url_for('notification.list', filter='unread') }}" class="btn btn-outline-secondary btn-sm {% if filter_type == 'unread' %}active{% endif %}">Unread</a>
            <a href="{{ url_for('notification.list', filter='read') }}" class="btn btn-outline-secondary btn-sm {% if filter_type == 'read' %}active{% endif %}">Read</a>
            {% if unread_count > 0 %}
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#markAllReadModal">Mark All Read</button>
            {% endif %}
        </div>
    </div>

    {% if notifications_list %}
    <div class="list-group">
        {% for notification in notifications_list %}
        <div class="list-group-item {% if not notification.is_read %}list-group-item-action{% endif %}" id="notification-{{ notification.id }}">
            <div class="d-flex w-100 justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas {{ notification.notification_icon }} text-{{ notification.notification_color }} me-2"></i>
                        <h5 class="mb-0 {% if not notification.is_read %}fw-bold{% endif %}">{{ notification.title }}</h5>
                        {% if not notification.is_read %}
                        <span class="badge bg-primary ms-2">New</span>
                        {% endif %}
                    </div>
                    <p class="mb-2 text-muted" style="white-space: pre-line;">{{ notification.message }}</p>
                    <small class="text-muted">{{ notification.created_at|datetime }}</small>
                    {% if notification.related_booking %}
                    <div class="mt-2">
                        <a href="{{ url_for('booking.details', id=notification.related_booking.id) }}" class="btn btn-sm btn-outline-primary">View Booking</a>
                    </div>
                    {% elif notification.related_resource %}
                    <div class="mt-2">
                        <a href="{{ url_for('resources.view', id=notification.related_resource.id) }}" class="btn btn-sm btn-outline-primary">View Resource</a>
                    </div>
                    {% endif %}
                </div>
                <div class="ms-3">
                    {% if notification.is_read %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="markUnread({{ notification.id }})" title="Mark as unread">
                        <i class="fas fa-envelope"></i>
                    </button>
                    {% else %}
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="openMarkReadModal({{ notification.id }})" title="Mark as read">
                        <i class="fas fa-check"></i>
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteNotification({{ notification.id }})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if notifications.pages > 1 %}
    <nav aria-label="Notifications pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if notifications.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('notification.list', page=notifications.prev_num, filter=filter_type) }}">Previous</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Previous</span>
            </li>
            {% endif %}
            
            {% for page_num in notifications.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                    {% if page_num == notifications.page %}
                    <li class="page-item active">
                        <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('notification.list', page=page_num, filter=filter_type) }}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">â€¦</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if notifications.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('notification.list', page=notifications.next_num, filter=filter_type) }}">Next</a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Next</span>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    {% else %}
    <div class="alert alert-info">
        <p class="mb-0">No notifications found.</p>
    </div>
    {% endif %}
</div>

<!-- Mark as Read Modal -->
<div class="modal fade" id="markReadModal" tabindex="-1" aria-labelledby="markReadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="markReadModalLabel">
                    <i class="fas fa-check-circle me-2"></i>Mark Notification as Read
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to mark this notification as read?</p>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>You can mark it as unread later if needed.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMarkReadBtn">
                    <i class="fas fa-check me-2"></i>Mark as Read
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Mark All as Read Modal -->
<div class="modal fade" id="markAllReadModal" tabindex="-1" aria-labelledby="markAllReadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="markAllReadModalLabel">
                    <i class="fas fa-check-double me-2"></i>Mark All Notifications as Read
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to mark all <strong>{{ unread_count }}</strong> unread notification{{ 's' if unread_count != 1 else '' }} as read?</p>
                <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>This action will mark all unread notifications as read. You can mark them as unread individually later if needed.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmMarkAllReadBtn">
                    <i class="fas fa-check-double me-2"></i>Mark All as Read
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentNotificationId = null;

function updateBadgeCount() {
    // Update the navbar badge count
    fetch('{{ url_for("notification.unread_count") }}')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                if (data.count > 0) {
                    badge.textContent = data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(error => console.error('Error updating badge count:', error));
}

function openMarkReadModal(id) {
    currentNotificationId = id;
    const modal = new bootstrap.Modal(document.getElementById('markReadModal'));
    modal.show();
}

function markRead(id) {
    fetch(`/notifications/${id}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the notification item in the UI
            const notificationItem = document.getElementById(`notification-${id}`);
            if (notificationItem) {
                // Remove "New" badge
                const newBadge = notificationItem.querySelector('.badge');
                if (newBadge) {
                    newBadge.remove();
                }
                
                // Update button
                const button = notificationItem.querySelector('button[onclick*="openMarkReadModal"]');
                if (button) {
                    button.outerHTML = '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="markUnread(' + id + ')" title="Mark as unread"><i class="fas fa-envelope"></i></button>';
                }
                
                // Remove bold from title
                const title = notificationItem.querySelector('h5');
                if (title) {
                    title.classList.remove('fw-bold');
                }
                
                // Remove action class
                notificationItem.classList.remove('list-group-item-action');
            }
            
            // Update badge count
            updateBadgeCount();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('markReadModal'));
            if (modal) {
                modal.hide();
            }
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
        alert('An error occurred. Please try again.');
    });
}

function markUnread(id) {
    fetch(`/notifications/${id}/unread`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the notification item in the UI
            const notificationItem = document.getElementById(`notification-${id}`);
            if (notificationItem) {
                // Add "New" badge
                const titleDiv = notificationItem.querySelector('.d-flex.align-items-center');
                if (titleDiv && !titleDiv.querySelector('.badge')) {
                    const newBadge = document.createElement('span');
                    newBadge.className = 'badge bg-primary ms-2';
                    newBadge.textContent = 'New';
                    titleDiv.appendChild(newBadge);
                }
                
                // Update button
                const button = notificationItem.querySelector('button[onclick*="markUnread"]');
                if (button) {
                    button.outerHTML = '<button type="button" class="btn btn-sm btn-outline-primary" onclick="openMarkReadModal(' + id + ')" title="Mark as read"><i class="fas fa-check"></i></button>';
                }
                
                // Add bold to title
                const title = notificationItem.querySelector('h5');
                if (title) {
                    title.classList.add('fw-bold');
                }
                
                // Add action class
                notificationItem.classList.add('list-group-item-action');
            }
            
            // Update badge count
            updateBadgeCount();
        }
    })
    .catch(error => {
        console.error('Error marking notification as unread:', error);
        alert('An error occurred. Please try again.');
    });
}

function deleteNotification(id) {
    if (confirm('Are you sure you want to delete this notification?')) {
        fetch(`/notifications/${id}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notificationItem = document.getElementById(`notification-${id}`);
                if (notificationItem) {
                    notificationItem.remove();
                }
                
                // Update badge count
                updateBadgeCount();
                
                // Reload if no notifications left
                if (document.querySelectorAll('.list-group-item').length === 0) {
                    location.reload();
                }
            }
        })
        .catch(error => {
            console.error('Error deleting notification:', error);
            alert('An error occurred. Please try again.');
        });
    }
}

function markAllRead() {
    fetch('/notifications/mark-all-read', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update all notification items
            document.querySelectorAll('.list-group-item').forEach(item => {
                const newBadge = item.querySelector('.badge');
                if (newBadge) {
                    newBadge.remove();
                }
                
                const title = item.querySelector('h5');
                if (title) {
                    title.classList.remove('fw-bold');
                }
                
                item.classList.remove('list-group-item-action');
                
                // Update buttons
                const button = item.querySelector('button[onclick*="openMarkReadModal"]');
                if (button) {
                    const id = button.getAttribute('onclick').match(/\d+/)[0];
                    button.outerHTML = '<button type="button" class="btn btn-sm btn-outline-secondary" onclick="markUnread(' + id + ')" title="Mark as unread"><i class="fas fa-envelope"></i></button>';
                }
            });
            
            // Update badge count
            updateBadgeCount();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('markAllReadModal'));
            if (modal) {
                modal.hide();
            }
            
            // Hide "Mark All Read" button if no unread notifications
            const markAllBtn = document.querySelector('button[data-bs-target="#markAllReadModal"]');
            if (markAllBtn) {
                markAllBtn.style.display = 'none';
            }
        }
    })
    .catch(error => {
        console.error('Error marking all notifications as read:', error);
        alert('An error occurred. Please try again.');
    });
}

// Set up modal confirm buttons
document.addEventListener('DOMContentLoaded', function() {
    const confirmMarkReadBtn = document.getElementById('confirmMarkReadBtn');
    if (confirmMarkReadBtn) {
        confirmMarkReadBtn.addEventListener('click', function() {
            if (currentNotificationId) {
                markRead(currentNotificationId);
            }
        });
    }
    
    const confirmMarkAllReadBtn = document.getElementById('confirmMarkAllReadBtn');
    if (confirmMarkAllReadBtn) {
        confirmMarkAllReadBtn.addEventListener('click', function() {
            markAllRead();
        });
    }
});
</script>
{% endblock %}

